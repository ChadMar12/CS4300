<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinetix – Seat Booking</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:opsz,wght@8..144,400;8..144,700&display=swap" rel="stylesheet" />

  {% load static %}
  <link rel="stylesheet" href="{% static 'bookings/styles.css' %}" />

  <style>
    :root{
      --bg:#0a0a0a;
      --panel:transparent;
      --panel-2:transparent;
      --header:#111;
      --text:#e9e7e4;
      --muted:#b8b3ac;
      --accent:#FDB94A;
      --accent-ink:#1b1406;
      --line:transparent;
      --ok:#4caf50;
      --seat-size: 26px;
      --seat-gap-x: 12px;
      --seat-gap-y: 12px;
    }
    html,body{height:100%;}
    html,body{
      background:var(--bg);
      color:var(--text);
      margin:0;
      font-family:"Roboto Serif",serif;
    }
    body{display:flex;flex-direction:column;min-height:100vh;}

    .header{ background:var(--header); }
    .topbar{
      max-width:1380px;
      margin:0 auto;
      height:60px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:0 16px;
    }
    .logo{height:34px; display:block;}

    main{ flex:1; display:block; width:100%; }
    .crumbs{
      max-width:1380px; margin:16px auto 8px; color:var(--muted); padding:0 16px;
    }
    .crumbs a{ color:var(--accent); text-decoration:none; }

    .wrap{
      max-width:1380px;
      margin:0 auto 80px;
      background:var(--panel);
      border:none;
      border-radius:0;
      padding:90px 16px 24px;
    }

    .booking{
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap:28px;
      align-items:start;
    }
    @media (max-width:1150px){ .booking{ grid-template-columns:1fr; } }

    .movie-info{ display:flex; flex-direction:column; gap:12px; }
    .poster{
      width:100%;
      max-width:220px;
      border-radius:6px;
      box-shadow:0 10px 36px rgba(0,0,0,.5);
    }
    .info-title{ font-size:18px; font-weight:700; }
    .info-muted{ color:var(--muted); font-size:14px; line-height:1.5; }

    .auditorium{
      background:var(--panel-2);
      padding:14px 0 0;
      position:relative;
    }

    .screen{
      width: 78%;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(180deg,#6d6d6d,#4a4a4a);
      margin: 0 auto 18px;
      position: relative;
    }
    .screen::after{
      content:"Screen";
      position:absolute;
      top:-18px;
      left:50%;
      transform:translateX(-50%);
      font-size:11px;
      color:#aaa;
      letter-spacing:.08em;
    }

    .ada-row{
      display:flex;
      justify-content:center;
      gap:14px;
      margin: 2px 0 12px;
    }
    .ada{
      width:20px;height:20px;border-radius:4px;
      background:#2f6bd1;
      display:flex;align-items:center;justify-content:center;
      font-size:13px;color:#fff;user-select:none;
    }

    .seats{
      display:grid;
      grid-template-columns: repeat(16, var(--seat-size));
      gap: var(--seat-gap-y) var(--seat-gap-x);
      justify-content:center;
      margin-top:6px;
    }
    .seat{
      width:var(--seat-size);
      height:var(--seat-size);
      border-radius:3px;
      background: var(--accent);
      box-shadow: 0 2px 0 rgba(0,0,0,.35);
      cursor:pointer; position:relative;
      outline: none; border:0;
      transition: transform .06s ease;
    }
    .seat:hover{ transform:translateY(-1px); }
    .seat[aria-checked="true"]{ background: var(--ok); }
    .seat.reserved{ background:#4e4e4e; cursor:not-allowed; box-shadow:none; opacity:.85; }

    .legend{
      display:flex; gap:14px; align-items:center;
      justify-content:center; margin-top:14px; color:#cfcfcf; font-size:13px;
      flex-wrap:wrap;
    }
    .legend .chip{ display:inline-flex; align-items:center; gap:6px; }
    .legend .box{ width:16px;height:16px;border-radius:3px;background:var(--accent);display:inline-block; }
    .legend .box.sel{ background:var(--ok); }
    .legend .box.res{ background:#4e4e4e; }

    .summary{
      background:#2A2A2A;
      border:1px solid #3a3a3a;
      border-radius:10px;
      padding:24px;
      position:sticky; top:40px;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
    }
    .sum-title{ font-size:20px;font-weight:700;margin-bottom:10px; }
    .sum-row{ color:var(--muted); font-size:14px; margin:10px 0; }
    .sum-row .value{ color:var(--text); font-weight:600; }
    .purchase{ margin-top:8px; display:flex; justify-content:flex-start; }
    .btn{
      background:var(--accent); color:var(--accent-ink);
      border:none;border-radius:24px; padding:10px 18px; font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(253,185,74,.25);
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; box-shadow:none; }

    footer.site-footer{
      background: var(--header);
      color: var(--text);
      margin-top:auto;
      width:100%;
    }
    .site-footer .footer-grid{
      max-width:1380px;
      margin:0 auto;
      padding:28px 16px 40px;
      display:grid;
      grid-template-columns: 2fr repeat(4, 1fr);
      gap:24px 32px;
    }
    .site-footer h3, .site-footer h4{ margin:0 0 10px; font-weight:700; color: var(--text); }
    .site-footer .muted{ color: var(--muted); }
    .site-footer a{ display:block; margin:6px 0; text-decoration:none; color: var(--muted); }
    .site-footer a:hover{ color: var(--accent); text-decoration: underline; }
    @media (max-width:900px){ .site-footer .footer-grid{ grid-template-columns:1fr 1fr; } }
    @media (max-width:560px){ .site-footer .footer-grid{ grid-template-columns:1fr; } }

    .warn{
      background:#3a2a00;
      border:1px solid #6a4a00;
      color:#ffd58a;
      border-radius:6px;
      padding:10px 12px;
      margin:0 auto 12px;
      max-width:1380px;
      font-size:14px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="topbar">
      <img src="{% static 'bookings/cinetix2.png' %}" alt="Cinetix" class="logo" />
    </div>
  </header>

  <main>
    <div class="crumbs">
      <a href="{% url 'bookings:movie_list' %}">← Back to all movies</a>
    </div>

    <div id="warn" class="warn" style="display:none;"></div>

    <div class="wrap">
      <div class="booking">
        <aside class="movie-info">
          <img id="bPoster" src="{% static 'bookings/fallback-poster.jpg' %}" alt="Poster" class="poster" />
          <div>
            <div id="bTitle" class="info-title">Movie</div>
            <div class="info-muted">
              <span id="bWhen">–</span><br/>
              <span id="bRuntime">Seat selection</span><br/>
              <span id="bWhere">–</span>
            </div>
          </div>
        </aside>

        <section class="auditorium" aria-label="Choose your seats">
          <div class="screen"></div>

          <div class="ada-row" aria-hidden="true">
            <div class="ada">♿</div><div class="ada">♿</div><div class="ada">♿</div>
            <div class="ada">♿</div><div class="ada">♿</div><div class="ada">♿</div>
          </div>

          <div id="seats" class="seats" role="grid" aria-label="Seats grid"></div>

          <div class="legend" aria-hidden="true">
            <span class="chip"><span class="box"></span>Available</span>
            <span class="chip"><span class="box sel"></span>Selected</span>
            <span class="chip"><span class="box res"></span>Reserved</span>
          </div>
        </section>

        <aside class="summary" aria-label="Ticket summary">
          <div class="sum-title">Tickets</div>
          <div class="sum-row">Seats: <span id="sumSeats" class="value">–</span></div>
          <div class="sum-row">Amount: <span id="sumAmount" class="value">$0.00</span></div>
          <div class="sum-row">Total: <span id="sumTotal" class="value">$0.00</span></div>

          <div class="purchase">
            <button id="btnBuy" class="btn" disabled>Purchase</button>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-grid">
      <div>
        <h3>CINETIX</h3>
        <p class="muted">Movie tickets, trailers &amp; showtimes.</p>
      </div>
      <div>
        <h4>Movies</h4>
        <a href="#">Features</a>
        <a href="#">Now Playing</a>
        <a href="#">Coming Soon</a>
      </div>
      <div>
        <h4>About Us</h4>
        <a href="#">Our Mission / Story</a>
        <a href="#">Careers</a>
      </div>
      <div>
        <h4>Support &amp; Contact</h4>
        <a href="#">Contact Us</a>
        <a href="#">FAQ</a>
        <a href="#">Customer Service</a>
      </div>
      <div>
        <h4>Legal &amp; Privacy</h4>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
        <a href="#">Cookie Settings</a>
        <a href="#">Licensing</a>
        <a href="#">Information</a>
      </div>
    </div>
  </footer>

  <script>
    function getBookingParams(){
      const p = new URLSearchParams(location.search);
      const rawDate   = p.get("date");
      const dateObj   = rawDate ? new Date(rawDate + "T12:00:00") : null;
      const niceDate  = dateObj
        ? new Intl.DateTimeFormat(undefined,{month:"long", day:"numeric", year:"numeric"}).format(dateObj)
        : null;

      return {
        id: p.get("id") || "",
        title: p.get("title") || "Movie",
        poster: p.get("poster") || "{% static 'bookings/fallback-poster.jpg' %}",
        dateISO: rawDate || "",
        dateNice: niceDate || "",
        time: p.get("time") || "",
        theater: p.get("theater") || "",
        runtimeMins: Number(p.get("runtimeMins") || 0)
      };
    }

    function showWarning(msg){
      const w = document.getElementById('warn');
      w.textContent = msg;
      w.style.display = 'block';
    }

    function minsToHM(mins){
      if(!mins || isNaN(mins)) return "";
      const h = Math.floor(mins/60), m = mins % 60;
      return `${h} hr ${m} min`;
    }

    function keyToLabel(key){
      const [rPart, cPart] = key.split("-");
      const r = parseInt(rPart.replace("R",""), 10);
      const c = parseInt(cPart.replace("C",""), 10);
      const letter = String.fromCharCode(64 + r);
      return `${letter}${c}`;
    }

    function populateFromParams(){
      const info = getBookingParams();

      const bPoster = document.getElementById("bPoster");
      const bTitle  = document.getElementById("bTitle");
      const bWhen   = document.getElementById("bWhen");
      const bWhere  = document.getElementById("bWhere");
      const bRuntime= document.getElementById("bRuntime");

      if(!info.title || !info.dateISO || !info.time || !info.theater){
        showWarning("Missing booking details in the link. Please go back and select a date, theater and time again.");
      }

      bTitle.textContent = info.title;
      bPoster.src = info.poster;
      bPoster.alt = info.title;
      bWhen.textContent = (info.dateNice && info.time) ? `${info.dateNice} • ${info.time}` : "–";
      bWhere.textContent = info.theater || "–";
      bRuntime.textContent = minsToHM(info.runtimeMins) || "–";
    }

    const PRICE = 14.50;
    const rows = 10, cols = 16;

    const reservedSet = new Set([
      "R1-C4","R1-C5","R1-C6","R1-C7",
      "R4-C3","R4-C14",
      "R6-C8","R6-C9",
      "R8-C1","R8-C16"
    ]);

    const seatGrid = document.getElementById('seats');
    const sumSeats = document.getElementById('sumSeats');
    const sumAmount = document.getElementById('sumAmount');
    const sumTotal = document.getElementById('sumTotal');
    const btnBuy = document.getElementById('btnBuy');

    const selected = new Set();

    function buildSeats(){
      seatGrid.innerHTML = "";

      for(let r=1; r<=rows; r++){
        for(let c=1; c<=cols; c++){
          const key = `R${r}-C${c}`;
          const div = document.createElement('button');
          div.type = "button";
          div.className = "seat";
          div.setAttribute('role','gridcell');
          div.setAttribute('aria-label', `Row ${r} Seat ${c}`);
          div.dataset.key = key;

          if(reservedSet.has(key)){
            div.classList.add('reserved');
            div.setAttribute('aria-disabled','true');
          }else{
            div.setAttribute('aria-checked','false');
            div.addEventListener('click', onSeatClick);
            div.addEventListener('keydown', (e)=>{
              if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); onSeatClick.call(div); }
            });
          }

          seatGrid.appendChild(div);
        }
      }
    }

    function onSeatClick(){
      const key = this.dataset.key;
      const checked = this.getAttribute('aria-checked') === 'true';

      if(checked){
        this.setAttribute('aria-checked','false');
        selected.delete(key);
      }else{
        this.setAttribute('aria-checked','true');
        selected.add(key);
      }
      updateSummary();
    }

    function updateSummary(){
      const count  = selected.size;
      const amount = count * PRICE;
      const labels = [...selected].map(keyToLabel);

      sumSeats.textContent = count ? labels.join(', ') : '–';
      sumAmount.textContent = `${amount.toFixed(2)}`;
      sumTotal.textContent  = `${amount.toFixed(2)}`;
      btnBuy.disabled = count === 0;
    }

    populateFromParams();
    buildSeats();
    updateSummary();

    btnBuy.addEventListener("click", () => {
      const seatKeys = Array.from(selected);
      if (seatKeys.length === 0) return;

      const info = getBookingParams();

      const ticket = {
        id: info.id,
        title: info.title,
        poster: info.poster,
        theater: info.theater,
        showDateISO: info.dateISO,
        showTime: info.time,
        runtimeMins: info.runtimeMins,
        seats: seatKeys,
        seatLabels: seatKeys.map(keyToLabel),
        purchasedAtISO: new Date().toISOString()
      };

      const KEY = "cinetix_tickets";
      let list = [];
      try {
        list = JSON.parse(localStorage.getItem(KEY) || "[]");
        if (!Array.isArray(list)) list = [];
      } catch { list = []; }

      const i = list.findIndex(t =>
        t.id === ticket.id &&
        t.showDateISO === ticket.showDateISO &&
        t.showTime === ticket.showTime &&
        t.theater === ticket.theater
      );
      if (i >= 0) {
        const mergedSeatKeys = Array.from(new Set([...(list[i].seats || []), ...ticket.seats]));
        const mergedSeatLabels = Array.from(new Set([...(list[i].seatLabels || []), ...ticket.seatLabels]));
        list[i] = { ...list[i], seats: mergedSeatKeys, seatLabels: mergedSeatLabels, purchasedAtISO: ticket.purchasedAtISO };
      } else {
        list.push(ticket);
      }

      localStorage.setItem(KEY, JSON.stringify(list));

      alert('Thank you for your purchase!')
      window.location.href = "{% url 'bookings:movie_list' %}";
    });
  </script>
</body>
</html>