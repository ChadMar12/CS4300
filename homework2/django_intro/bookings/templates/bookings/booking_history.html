<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cinetix – My Tickets</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:ital,opsz,wght@0,8..144,100..900;1,8..144,100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Chewy&display=swap" rel="stylesheet" />

  <!-- Your site stylesheet -->
  {% load static %}
  <link rel="stylesheet" href="{% static 'bookings/styles.css' %}" />

  <style>
    .tickets-header {
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .tickets-header h1 { margin:0; }
    .btn-clear {
      background: var(--accent, #FDB94A);
      color: var(--accent-ink, #1b1406);
      border: none;
      border-radius: 24px;
      padding: 10px 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(253,185,74,.25);
    }
    .btn-clear:disabled { opacity:.5; cursor:not-allowed; box-shadow:none; }

    .ticket-card {
      display:grid; grid-template-columns: 90px 1fr auto; gap:14px;
      align-items:center; background:#222; border:1px solid #333; border-radius:10px;
      padding:12px; margin:12px 0; box-shadow:0 6px 18px rgba(0,0,0,.2);
    }
    .ticket-poster { width:90px; height:auto; border-radius:6px; object-fit:cover; }
    .ticket-title { font-weight:700; font-size:1.05rem; margin-bottom:2px; }
    .ticket-meta { color: var(--muted, #b8b3ac); font-size:.95rem; margin:2px 0; }
    .ticket-chevron { font-size:28px; color: var(--muted, #b8b3ac); padding:0 6px; }

    .seat-badges { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .seat-badge {
      display:inline-block; padding:4px 8px; border-radius:999px;
      background:#2f6bd1; color:#fff; font-size:.85rem; line-height:1;
    }

    .tickets-empty { color: var(--muted, #b8b3ac); margin:8px 0 0 0; }
  </style>
</head>
<body class="page">
  <!-- Header / Nav -->
  <div class="header">
    <nav>
      <a href="{% url 'bookings:home' %}" aria-label="Home">
        <img src="{% static 'bookings/cinetix2.png' %}" class="logo" alt="Cinetix" />
      </a>
      <ul>
        <li><a href="{% url 'bookings:movie_list' %}">Movies</a></li>
        <li><a href="{% url 'bookings:booking_history' %}">My Tickets</a></li>
        <li><a href="#">Theaters</a></li>
      </ul>
      <div class="user">
        <img src="{% static 'bookings/user.png' %}" alt="user">
        <li><a href="{% url 'bookings:booking_history' %}">User</a></li>
      </div>
    </nav>
  </div>

  <!-- MAIN -->
  <main class="page-main">
    <div class="tickets">
      <div class="tickets-header">
        <h1>My Tickets</h1>
        <button id="btnClear" class="btn-clear" title="Remove all bookings" disabled>Clear all tickets</button>
      </div>

      <div class="ticket-list" id="ticketList"></div>
    </div>

    <!-- Template for each ticket -->
    <template id="ticketTpl">
      <article class="ticket-card">
        <img class="ticket-poster" alt="">
        <div class="ticket-info">
          <div class="ticket-title"></div>
          <div class="ticket-meta theater"></div>
          <div class="ticket-meta datetime"></div>
          <div class="seat-badges"></div>
        </div>
        <div class="ticket-chevron">›</div>
      </article>
    </template>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-grid">
      <div>
        <h3>CINETIX</h3>
        <p class="muted">Movie tickets, trailers &amp; showtimes.</p>
      </div>
      <div>
        <h4>Movies</h4>
        <a href="#">Features</a>
        <a href="#">Now Playing</a>
        <a href="#">Coming Soon</a>
      </div>
      <div>
        <h4>About Us</h4>
        <a href="#">Our Mission / Story</a>
        <a href="#">Careers</a>
      </div>
      <div>
        <h4>Support &amp; Contact</h4>
        <a href="#">Contact Us</a>
        <a href="#">FAQ</a>
        <a href="#">Customer Service</a>
      </div>
      <div>
        <h4>Legal &amp; Privacy</h4>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
        <a href="#">Cookie Settings</a>
        <a href="#">Licensing</a>
        <a href="#">Information</a>
      </div>
    </div>
  </footer>

  <script>
    const API_KEY = "{{ TMDB_API_KEY }}";
    const IMG_BASE = "https://image.tmdb.org/t/p/w500";
    const listEl = document.getElementById("ticketList");
    const tpl = document.getElementById("ticketTpl");
    const btnClear = document.getElementById("btnClear");
    const IMG_FALLBACK = "{% static 'bookings/fallback-poster.jpg' %}";

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function formatDateNice(isoDateTime){
      if(!isoDateTime) return "";
      const d = new Date(isoDateTime);
      return new Intl.DateTimeFormat(undefined, { 
        month: "short", 
        day: "numeric",
        year: "numeric"
      }).format(d);
    }

    async function fetchMovieDetails(tmdbId) {
      try {
        const url = `https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${API_KEY}&language=en-US`;
        const response = await fetch(url);
        if (!response.ok) return null;
        return await response.json();
      } catch {
        return null;
      }
    }

    async function fetchShowingDetails(showingId) {
      try {
        const response = await fetch(`/api/showings/${showingId}/`);
        if (!response.ok) return null;
        return await response.json();
      } catch {
        return null;
      }
    }

    async function renderTicket(booking){
      const node = tpl.content.cloneNode(true);
      
      // Get showing details to find the movie's TMDB ID
      const showing = await fetchShowingDetails(booking.showing_id);
      
      let poster = IMG_FALLBACK;
      let title = booking.movie_title || "Movie";
      
      if (showing && showing.movie) {
        // Fetch TMDB details if we have a tmdb_id
        const movieDetails = await fetchMovieDetails(showing.movie);
        if (movieDetails) {
          title = movieDetails.title || title;
          poster = movieDetails.poster_path ? IMG_BASE + movieDetails.poster_path : IMG_FALLBACK;
        }
      }
      
      node.querySelector(".ticket-poster").src = poster;
      node.querySelector(".ticket-poster").alt = title + " poster";
      node.querySelector(".ticket-title").textContent = title;
      
      if (showing) {
        node.querySelector(".theater").textContent = showing.theater_name || "";
        const dateStr = formatDateNice(showing.show_date);
        const timeStr = showing.show_time || "";
        node.querySelector(".datetime").textContent = 
          (dateStr && timeStr) ? `${dateStr} • ${timeStr}` : (dateStr || timeStr || "");
      }
      
      const seatBadge = document.createElement("span");
      seatBadge.className = "seat-badge";
      seatBadge.textContent = booking.seat_number || "Seat";
      node.querySelector(".seat-badges").appendChild(seatBadge);
      
      listEl.appendChild(node);
    }

    async function loadTickets(){
      try {
        const response = await fetch('/api/bookings/');
        if (!response.ok) throw new Error('Failed to load bookings');
        const bookings = await response.json();
        return bookings;
      } catch (error) {
        console.error('Error loading bookings:', error);
        return [];
      }
    }

    async function renderTickets(bookings){
      listEl.innerHTML = "";
      
      if(!bookings.length){
        const empty = document.createElement("p");
        empty.className = "tickets-empty";
        empty.textContent = "No tickets yet. Buy one and it will show here.";
        listEl.appendChild(empty);
        btnClear.disabled = true;
        return;
      }
      
      btnClear.disabled = false;
      
      // Sort by booking date (newest first)
      bookings.sort((a,b)=> new Date(b.booking_date) - new Date(a.booking_date));
      
      // Render each booking
      for (const booking of bookings) {
        await renderTicket(booking);
      }
    }

    async function loadAndRender(){
      const bookings = await loadTickets();
      await renderTickets(bookings);
    }

    async function clearAllTickets(){
      if(!confirm("Delete all bookings? This cannot be undone.")) return;
      
      try {
        const bookings = await loadTickets();
        
        for (const booking of bookings) {
          await fetch(`/api/bookings/${booking.id}/`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          });
        }
        
        await loadAndRender();
      } catch (error) {
        console.error('Error deleting bookings:', error);
        alert('Failed to delete bookings. Please try again.');
      }
    }

    btnClear.addEventListener("click", clearAllTickets);
    loadAndRender();
  </script>
</body>
</html>